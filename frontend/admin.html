<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel | Stress Tone AI</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        :root {
            --bg: #f3f6fb;
            --card: #ffffff;
            --line: #d7dfeb;
            --primary: #0f3d75;
            --primary-soft: #e9f0fb;
            --danger: #b91c1c;
            --danger-soft: #fee2e2;
            --ok: #166534;
            --text: #1f2937;
            --muted: #6b7280;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: "Segoe UI", Tahoma, sans-serif;
            background: linear-gradient(180deg, #edf3fb 0%, #f7f9fc 45%, #edf2f7 100%);
            color: var(--text);
            min-height: 100vh;
        }

        /* Official Header Bar */
        .official-header {
            width: 100%;
            background: var(--primary);
            color: white;
            padding: 0.8rem 2rem;
            border-bottom: 4px solid #c62828;
            text-align: center;
            font-size: 0.85rem;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .top-bar {
            background: var(--primary);
            color: #fff;
            border-bottom: 4px solid #c62828;
            padding: 0.9rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        .top-bar h1 {
            font-size: 1rem;
            letter-spacing: 0.4px;
            text-transform: uppercase;
        }

        .top-actions {
            display: flex;
            gap: 0.7rem;
            align-items: center;
            font-size: 0.85rem;
        }

        .btn {
            border: 1px solid var(--line);
            background: var(--card);
            color: var(--text);
            padding: 0.5rem 0.8rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .btn:hover {
            filter: brightness(0.98);
        }

        .btn-primary {
            background: var(--primary);
            color: #fff;
            border-color: var(--primary);
        }

        .btn-danger {
            background: var(--danger-soft);
            color: var(--danger);
            border-color: #fecaca;
        }

        .hidden {
            display: none !important;
        }

        .container {
            max-width: 1320px;
            margin: 1.2rem auto;
            padding: 0 1rem 1.5rem;
        }

        .message {
            margin-bottom: 1rem;
            border-radius: 10px;
            padding: 0.7rem 0.9rem;
            border: 1px solid var(--line);
            background: #fff;
            color: var(--text);
            font-size: 0.9rem;
        }

        .message.error {
            border-color: #fecaca;
            background: #fef2f2;
            color: #991b1b;
        }

        .message.success {
            border-color: #bbf7d0;
            background: #f0fdf4;
            color: var(--ok);
        }

        .login-wrap {
            min-height: calc(100vh - 64px);
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }

        .login-card {
            width: 100%;
            max-width: 420px;
            border: 1px solid var(--line);
            border-radius: 14px;
            background: var(--card);
            box-shadow: 0 12px 30px rgba(15, 61, 117, 0.08);
            padding: 1.4rem;
        }

        .login-card h2 {
            color: var(--primary);
            margin-bottom: 0.2rem;
            font-size: 1.15rem;
        }

        .login-card p {
            color: var(--muted);
            font-size: 0.85rem;
            margin-bottom: 1rem;
        }

        .field {
            margin-bottom: 0.8rem;
        }

        .field label {
            display: block;
            font-size: 0.8rem;
            margin-bottom: 0.3rem;
            color: #334155;
            font-weight: 700;
            text-transform: uppercase;
        }

        .field input, .field textarea {
            width: 100%;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            padding: 0.6rem 0.7rem;
            font-size: 0.92rem;
            background: #fff;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.8rem;
            margin-bottom: 1rem;
        }

        .stat-card {
            border: 1px solid var(--line);
            border-radius: 10px;
            background: var(--card);
            padding: 0.9rem;
        }

        .stat-card .label {
            font-size: 0.75rem;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.35rem;
            display: block;
            font-weight: 700;
        }

        .stat-card .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .layout {
            display: grid;
            grid-template-columns: 1.1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .panel {
            border: 1px solid var(--line);
            border-radius: 12px;
            background: var(--card);
            overflow: hidden;
        }

        .panel-head {
            border-bottom: 1px solid var(--line);
            padding: 0.8rem;
            background: var(--primary-soft);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.7rem;
        }

        .panel-head h3 {
            font-size: 0.95rem;
            color: #0a2f5c;
        }

        .panel-body {
            padding: 0.8rem;
        }

        .inline-tools {
            display: flex;
            gap: 0.45rem;
            align-items: center;
        }

        .inline-tools input {
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            padding: 0.5rem 0.6rem;
            min-width: 220px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.84rem;
        }

        th, td {
            border-bottom: 1px solid #e2e8f0;
            text-align: left;
            padding: 0.55rem;
            vertical-align: top;
        }

        th {
            background: #f8fbff;
            color: #334155;
            font-size: 0.74rem;
            text-transform: uppercase;
        }

        .tiny {
            color: var(--muted);
            font-size: 0.76rem;
        }

        .tag {
            display: inline-block;
            padding: 0.2rem 0.45rem;
            border-radius: 999px;
            font-size: 0.72rem;
            font-weight: 700;
            background: #eef2ff;
            color: #1d4ed8;
        }

        .tag.high {
            background: #fee2e2;
            color: #991b1b;
        }

        .tag.moderate {
            background: #ffedd5;
            color: #9a3412;
        }

        .tag.low {
            background: #dcfce7;
            color: #166534;
        }

        .report-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 0.55rem;
            margin-bottom: 0.8rem;
        }

        .report-item {
            border: 1px solid #dbe5f3;
            border-radius: 8px;
            padding: 0.55rem;
            background: #f9fbff;
        }

        .report-item .k {
            font-size: 0.73rem;
            color: var(--muted);
            text-transform: uppercase;
            font-weight: 700;
        }

        .report-item .v {
            margin-top: 0.2rem;
            font-size: 1.05rem;
            font-weight: 700;
            color: #0f3d75;
        }

        .recordings-panel {
            margin-top: 1rem;
        }

        .audio-cell audio {
            width: 200px;
            max-width: 100%;
            height: 30px;
        }

        @media (max-width: 1100px) {
            .layout {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 760px) {
            .top-bar {
                flex-direction: column;
                align-items: flex-start;
            }
            .inline-tools {
                width: 100%;
                flex-wrap: wrap;
            }
            .inline-tools input {
                min-width: unset;
                width: 100%;
            }
            .audio-cell audio {
                width: 150px;
            }
        }
    </style>
</head>
<body>
    <!-- Official Header -->
    <div class="official-header">
        <i class="fas fa-shield-alt"></i> Official Government Health Service Portal | Ministry of Mental Health & Wellness
    </div>
    <div class="top-bar">
        <h1><i class="fas fa-user-shield"></i> Admin Control Center</h1>
        <div class="top-actions">
            <span id="admin-email-label" class="tiny">Not logged in</span>
            <a href="index.html" class="btn">Portal Login</a>
            <button id="logout-btn" class="btn btn-danger hidden" onclick="logoutAdmin()">Logout</button>
        </div>
    </div>

    <div id="login-view" class="login-wrap">
        <form class="login-card" onsubmit="loginAdmin(event)">
            <h2>Admin Sign In</h2>
            <p>Manage users, recordings, and stress reports.</p>
            <div id="login-msg" class="message hidden"></div>

            <div class="field">
                <label for="admin-email">Email</label>
                <input id="admin-email" type="email" required value="admin@stress-tone.local" />
            </div>

            <div class="field">
                <label for="admin-password">Password</label>
                <input id="admin-password" type="password" required value="admin123" />
            </div>

            <button class="btn btn-primary" type="submit" style="width: 100%;">
                <i class="fas fa-lock-open"></i> Enter Admin Panel
            </button>
        </form>
    </div>

    <div id="admin-view" class="container hidden">
        <div id="app-msg" class="message hidden"></div>

        <div class="stats-grid" id="stats-grid">
            <div class="stat-card"><span class="label">Total Users</span><span class="value" id="st-users">--</span></div>
            <div class="stat-card"><span class="label">Total Analyses</span><span class="value" id="st-analyses">--</span></div>
            <div class="stat-card"><span class="label">Recordings</span><span class="value" id="st-recordings">--</span></div>
            <div class="stat-card"><span class="label">High Stress Cases</span><span class="value" id="st-high">--</span></div>
            <div class="stat-card"><span class="label">Average Score</span><span class="value" id="st-avg">--</span></div>
            <div class="stat-card"><span class="label">AI Status</span><span class="value" id="st-ai">--</span></div>
        </div>

        <div class="layout">
            <section class="panel">
                <div class="panel-head">
                    <h3><i class="fas fa-users"></i> Users</h3>
                    <div class="inline-tools">
                        <input id="user-search" type="text" placeholder="Search name or email" />
                        <button class="btn" onclick="loadUsers()"><i class="fas fa-search"></i> Search</button>
                        <button class="btn" onclick="refreshAll()"><i class="fas fa-rotate"></i> Refresh</button>
                    </div>
                </div>
                <div class="panel-body" style="overflow:auto; max-height: 560px;">
                    <table>
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Analyses</th>
                                <th>Last Activity</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            <tr><td colspan="4" class="tiny">No data</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section class="panel">
                <div class="panel-head">
                    <h3><i class="fas fa-file-medical-alt"></i> User Report</h3>
                    <span class="tiny" id="selected-user-label">Select a user</span>
                </div>
                <div class="panel-body">
                    <div class="report-grid" id="report-grid">
                        <div class="report-item"><div class="k">Total Analyses</div><div class="v" id="rp-total">--</div></div>
                        <div class="report-item"><div class="k">Average Score</div><div class="v" id="rp-score">--</div></div>
                        <div class="report-item"><div class="k">Dominant Emotion</div><div class="v" id="rp-emotion">--</div></div>
                        <div class="report-item"><div class="k">Avg Water (L)</div><div class="v" id="rp-water">--</div></div>
                    </div>

                    <div class="field">
                        <label for="ud-name">Name</label>
                        <input id="ud-name" type="text" />
                    </div>
                    <div class="field">
                        <label for="ud-age">Age</label>
                        <input id="ud-age" type="number" min="1" />
                    </div>
                    <div class="field">
                        <label for="ud-phone">Phone</label>
                        <input id="ud-phone" type="text" />
                    </div>
                    <div class="field">
                        <label for="ud-address">Address</label>
                        <textarea id="ud-address" rows="2"></textarea>
                    </div>

                    <div class="inline-tools" style="margin-top: 0.5rem;">
                        <button class="btn btn-primary" onclick="saveSelectedUser()"><i class="fas fa-save"></i> Save User</button>
                        <button class="btn btn-danger" onclick="deleteSelectedUser()"><i class="fas fa-user-xmark"></i> Delete User</button>
                    </div>

                    <div style="margin-top: 1rem; overflow:auto; max-height: 280px; border:1px solid #e2e8f0; border-radius:8px;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date/Time</th>
                                    <th>Stress</th>
                                    <th>Score</th>
                                    <th>Recording</th>
                                </tr>
                            </thead>
                            <tbody id="user-analyses-body">
                                <tr><td colspan="4" class="tiny">Select user to load report.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </div>

        <section class="panel recordings-panel">
            <div class="panel-head">
                <h3><i class="fas fa-wave-square"></i> Recordings & Reports Feed</h3>
                <span class="tiny">Latest uploaded analyses across portal</span>
            </div>
            <div class="panel-body" style="overflow:auto; max-height: 360px;">
                <table>
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Date/Time</th>
                            <th>Stress</th>
                            <th>Emotion</th>
                            <th>Score</th>
                            <th>Recording</th>
                        </tr>
                    </thead>
                    <tbody id="recordings-body">
                        <tr><td colspan="6" class="tiny">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let adminToken = localStorage.getItem('adminToken') || '';
        let adminEmail = localStorage.getItem('adminEmail') || '';
        let selectedUserEmail = null;

        function escapeHtml(value) {
            return String(value || '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function showMessage(id, text, type) {
            const el = document.getElementById(id);
            if (!el) return;
            if (!text) {
                el.className = 'message hidden';
                el.textContent = '';
                return;
            }
            el.className = `message ${type || ''}`.trim();
            el.textContent = text;
        }

        function updateTopLabels() {
            document.getElementById('admin-email-label').textContent = adminEmail ? `Signed in: ${adminEmail}` : 'Not logged in';
            document.getElementById('logout-btn').classList.toggle('hidden', !adminToken);
        }

        async function apiRequest(path, options = {}) {
            const method = options.method || 'GET';
            const body = options.body;
            const headers = options.headers || {};

            if (adminToken) {
                headers['Authorization'] = `Bearer ${adminToken}`;
            }
            if (body !== undefined && body !== null) {
                headers['Content-Type'] = 'application/json';
            }

            const response = await fetch(`${API_BASE}${path}`, {
                method,
                headers,
                body: body !== undefined && body !== null ? JSON.stringify(body) : undefined,
            });

            let payload = {};
            try {
                payload = await response.json();
            } catch (error) {
                payload = {};
            }

            if (!response.ok) {
                const message = payload.message || `Request failed (${response.status})`;
                throw new Error(message);
            }

            return payload;
        }

        function showAdminView() {
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('admin-view').classList.remove('hidden');
            updateTopLabels();
        }

        function showLoginView() {
            document.getElementById('admin-view').classList.add('hidden');
            document.getElementById('login-view').classList.remove('hidden');
            updateTopLabels();
        }

        async function loginAdmin(event) {
            event.preventDefault();
            showMessage('login-msg', 'Signing in...', '');

            const email = document.getElementById('admin-email').value.trim().toLowerCase();
            const password = document.getElementById('admin-password').value;

            try {
                const data = await apiRequest('/api/admin/login', {
                    method: 'POST',
                    body: { email, password },
                });
                adminToken = data.token;
                adminEmail = data.admin_email || email;
                localStorage.setItem('adminToken', adminToken);
                localStorage.setItem('adminEmail', adminEmail);
                showMessage('login-msg', 'Login successful.', 'success');
                showAdminView();
                await refreshAll();
            } catch (error) {
                showMessage('login-msg', error.message, 'error');
            }
        }

        function logoutAdmin() {
            adminToken = '';
            adminEmail = '';
            selectedUserEmail = null;
            localStorage.removeItem('adminToken');
            localStorage.removeItem('adminEmail');
            showMessage('app-msg', 'Logged out.', 'success');
            showLoginView();
        }

        function stressTag(stressText) {
            const text = String(stressText || '').toLowerCase();
            if (text.includes('high')) return '<span class="tag high">High</span>';
            if (text.includes('mod')) return '<span class="tag moderate">Moderate</span>';
            return '<span class="tag low">Low</span>';
        }

        async function loadOverview() {
            const data = await apiRequest('/api/admin/overview');
            const counts = data.counts || {};
            document.getElementById('st-users').textContent = counts.total_users ?? '--';
            document.getElementById('st-analyses').textContent = counts.total_analyses ?? '--';
            document.getElementById('st-recordings').textContent = counts.total_recordings ?? '--';
            document.getElementById('st-high').textContent = counts.high_stress_count ?? '--';
            document.getElementById('st-avg').textContent = counts.average_score !== undefined ? `${counts.average_score}%` : '--';
            document.getElementById('st-ai').textContent = data.ai_enabled ? 'Online' : 'Fallback';
        }

        async function loadUsers() {
            const query = document.getElementById('user-search').value.trim();
            const path = query
                ? `/api/admin/users?query=${encodeURIComponent(query)}&limit=300`
                : '/api/admin/users?limit=300';
            const data = await apiRequest(path);
            const rows = data.users || [];
            const body = document.getElementById('users-table-body');

            if (!rows.length) {
                body.innerHTML = '<tr><td colspan="4" class="tiny">No users found.</td></tr>';
                return;
            }

            body.innerHTML = rows.map((user) => {
                const name = escapeHtml(user.full_name || user.email);
                const email = escapeHtml(user.email);
                const analyses = Number(user.analyses_count || 0);
                const last = escapeHtml(user.last_analysis_at || '-');
                return `
                    <tr>
                        <td>
                            <strong>${name}</strong><br>
                            <span class="tiny">${email}</span>
                        </td>
                        <td>${analyses}</td>
                        <td class="tiny">${last}</td>
                        <td><button class="btn" onclick="selectUser('${email.replace(/'/g, "\\'")}')">View</button></td>
                    </tr>
                `;
            }).join('');
        }

        function reportValue(id, value) {
            const el = document.getElementById(id);
            if (el) el.textContent = value;
        }

        function renderUserAnalyses(analyses) {
            const body = document.getElementById('user-analyses-body');
            if (!analyses || !analyses.length) {
                body.innerHTML = '<tr><td colspan="4" class="tiny">No analyses for selected user.</td></tr>';
                return;
            }

            body.innerHTML = analyses.map((item) => {
                const file = item.audio_file || '';
                const audio = file
                    ? `<audio controls preload="none" src="${API_BASE}/api/admin/audio/${encodeURIComponent(file)}?token=${encodeURIComponent(adminToken)}"></audio>`
                    : '<span class="tiny">No file</span>';
                return `
                    <tr>
                        <td>${escapeHtml(item.date)}<br><span class="tiny">${escapeHtml(item.time)}</span></td>
                        <td>${stressTag(item.stress_level)}</td>
                        <td>${Number(item.score || 0).toFixed(1)}%</td>
                        <td class="audio-cell">${audio}</td>
                    </tr>
                `;
            }).join('');
        }

        async function selectUser(email) {
            selectedUserEmail = String(email || '').trim().toLowerCase();
            if (!selectedUserEmail) return;

            showMessage('app-msg', `Loading report for ${selectedUserEmail}...`, '');
            const data = await apiRequest(`/api/admin/users/${encodeURIComponent(selectedUserEmail)}`);

            const user = data.user || {};
            const report = data.report || {};
            document.getElementById('selected-user-label').textContent = selectedUserEmail;
            document.getElementById('ud-name').value = user.name || '';
            document.getElementById('ud-age').value = user.age || '';
            document.getElementById('ud-phone').value = user.phone || '';
            document.getElementById('ud-address').value = user.address || '';

            reportValue('rp-total', report.total_analyses ?? 0);
            reportValue('rp-score', report.average_score !== undefined ? `${report.average_score}%` : '--');
            reportValue('rp-emotion', report.dominant_emotion || '--');
            reportValue('rp-water', report.average_water_intake !== undefined ? report.average_water_intake : '--');

            renderUserAnalyses(data.analyses || []);
            showMessage('app-msg', `Loaded ${selectedUserEmail}`, 'success');
        }

        async function saveSelectedUser() {
            if (!selectedUserEmail) {
                showMessage('app-msg', 'Select a user first.', 'error');
                return;
            }

            const payload = {
                full_name: document.getElementById('ud-name').value.trim(),
                age: document.getElementById('ud-age').value.trim(),
                phone: document.getElementById('ud-phone').value.trim(),
                address: document.getElementById('ud-address').value.trim(),
            };

            try {
                await apiRequest(`/api/admin/users/${encodeURIComponent(selectedUserEmail)}`, {
                    method: 'PUT',
                    body: payload,
                });
                showMessage('app-msg', 'User updated successfully.', 'success');
                await loadUsers();
                await selectUser(selectedUserEmail);
            } catch (error) {
                showMessage('app-msg', error.message, 'error');
            }
        }

        async function deleteSelectedUser() {
            if (!selectedUserEmail) {
                showMessage('app-msg', 'Select a user first.', 'error');
                return;
            }

            const confirmDelete = confirm(`Delete ${selectedUserEmail} and all related reports/recordings?`);
            if (!confirmDelete) return;

            try {
                await apiRequest(`/api/admin/users/${encodeURIComponent(selectedUserEmail)}`, {
                    method: 'DELETE',
                });

                selectedUserEmail = null;
                document.getElementById('selected-user-label').textContent = 'Select a user';
                document.getElementById('ud-name').value = '';
                document.getElementById('ud-age').value = '';
                document.getElementById('ud-phone').value = '';
                document.getElementById('ud-address').value = '';
                reportValue('rp-total', '--');
                reportValue('rp-score', '--');
                reportValue('rp-emotion', '--');
                reportValue('rp-water', '--');
                renderUserAnalyses([]);

                showMessage('app-msg', 'User deleted with related data.', 'success');
                await refreshAll();
            } catch (error) {
                showMessage('app-msg', error.message, 'error');
            }
        }

        async function loadRecordings() {
            const data = await apiRequest('/api/admin/analyses?limit=250');
            const rows = data.analyses || [];
            const body = document.getElementById('recordings-body');

            if (!rows.length) {
                body.innerHTML = '<tr><td colspan="6" class="tiny">No recordings found.</td></tr>';
                return;
            }

            body.innerHTML = rows.map((item) => {
                const stress = stressTag(item.stress_level);
                const audio = item.audio_file
                    ? `<audio controls preload="none" src="${API_BASE}/api/admin/audio/${encodeURIComponent(item.audio_file)}?token=${encodeURIComponent(adminToken)}"></audio>`
                    : '<span class="tiny">No file</span>';

                return `
                    <tr>
                        <td>
                            <strong>${escapeHtml(item.full_name || item.user_email)}</strong><br>
                            <span class="tiny">${escapeHtml(item.user_email)}</span>
                        </td>
                        <td>${escapeHtml(item.date)}<br><span class="tiny">${escapeHtml(item.time)}</span></td>
                        <td>${stress}</td>
                        <td>${escapeHtml(item.emotion || '-')}</td>
                        <td>${Number(item.score || 0).toFixed(1)}%</td>
                        <td class="audio-cell">${audio}</td>
                    </tr>
                `;
            }).join('');
        }

        async function refreshAll() {
            try {
                await loadOverview();
                await loadUsers();
                await loadRecordings();
                if (selectedUserEmail) {
                    await selectUser(selectedUserEmail);
                }
            } catch (error) {
                if (String(error.message || '').toLowerCase().includes('authorization')) {
                    logoutAdmin();
                    showMessage('login-msg', 'Session expired. Please sign in again.', 'error');
                } else {
                    showMessage('app-msg', error.message, 'error');
                }
            }
        }

        async function bootstrap() {
            updateTopLabels();
            if (!adminToken) {
                showLoginView();
                return;
            }

            showAdminView();
            await refreshAll();
            setInterval(loadOverview, 60000);
        }

        bootstrap();
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Scan | VocalVibe Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0ea5e9;
            --secondary: #6366f1;
            --bg: #020617;
            --surface: #0f172a;
            --surface-2: #111c31;
            --border: rgba(255, 255, 255, 0.1);
            --text: #f8fafc;
            --muted: #94a3b8;
            --success: #10b981;
            --danger: #ef4444;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background: var(--bg); color: var(--text); min-height: 100vh; display: flex; }

        .sidebar {
            width: 240px;
            background: var(--surface);
            border-right: 1px solid var(--border);
            padding: 24px 14px;
            position: fixed;
            inset: 0 auto 0 0;
        }

        .brand { display: flex; align-items: center; gap: 10px; font-weight: 800; margin-bottom: 24px; }
        .brand i {
            width: 34px; height: 34px; display: grid; place-items: center;
            border-radius: 8px; background: linear-gradient(135deg, #0ea5e9, #6366f1);
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 14px;
            color: var(--muted);
            text-decoration: none;
            border-radius: 10px;
            margin-bottom: 8px;
            border: 1px solid transparent;
        }
        .nav-item:hover, .nav-item.active { color: var(--primary); border-color: var(--border); background: var(--surface-2); }

        .logout-wrap { margin-top: 24px; }

        .main {
            margin-left: 240px;
            width: calc(100% - 240px);
            padding: 28px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .muted { color: var(--muted); }

        .user-pill {
            border: 1px solid var(--border);
            background: var(--surface);
            padding: 8px 12px;
            border-radius: 999px;
            font-size: 0.88rem;
        }

        .record-card {
            max-width: 760px;
            margin: 0 auto;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
        }

        .pulse-wrapper {
            position: relative;
            width: 280px;
            height: 280px;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pulse-ring {
            position: absolute;
            inset: 0;
            border: 2px solid var(--primary);
            border-radius: 999px;
            opacity: 0;
        }

        .recording .pulse-ring { animation: pulse 2s infinite; opacity: 0.55; }
        .recording .pulse-ring:nth-child(2) { animation-delay: 0.5s; }
        .recording .pulse-ring:nth-child(3) { animation-delay: 1s; }

        @keyframes pulse {
            from { transform: scale(0.8); opacity: 0.55; }
            to { transform: scale(1.5); opacity: 0; }
        }

        .mic-btn {
            width: 96px;
            height: 96px;
            border: none;
            border-radius: 999px;
            color: white;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            cursor: pointer;
            font-size: 2rem;
            z-index: 1;
        }

        .mic-btn.recording { background: var(--danger); }

        .timer {
            font-family: Consolas, monospace;
            font-weight: 800;
            font-size: 2rem;
            margin-bottom: 8px;
        }

        .status { color: var(--muted); margin-bottom: 18px; }

        .msg {
            display: none;
            text-align: left;
            border-radius: 10px;
            padding: 10px 12px;
            margin-bottom: 12px;
            font-size: 0.9rem;
            border: 1px solid var(--border);
        }
        .msg.error { color: #fecaca; background: rgba(239, 68, 68, 0.12); border-color: rgba(239, 68, 68, 0.3); }
        .msg.success { color: #bbf7d0; background: rgba(16, 185, 129, 0.12); border-color: rgba(16, 185, 129, 0.3); }

        .actions {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 16px;
        }

        .btn {
            border: 1px solid var(--border);
            background: #18253d;
            color: var(--text);
            border-radius: 8px;
            padding: 10px 14px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 700;
        }
        .btn:hover { border-color: #335277; }
        .btn.primary { background: var(--primary); border-color: var(--primary); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }

        .upload-box {
            border: 1px dashed var(--border);
            border-radius: 12px;
            padding: 18px;
            color: var(--muted);
            cursor: pointer;
            background: rgba(255,255,255,0.02);
        }
        .upload-box:hover { border-color: #335277; color: #cbd5e1; }

        @media (max-width: 980px) {
            .sidebar { position: static; width: 100%; height: auto; }
            body { display: block; }
            .main { margin-left: 0; width: 100%; }
            .pulse-wrapper { width: 230px; height: 230px; }
        }
    </style>
</head>
<body>
    <aside class="sidebar">
        <div class="brand"><i class="fas fa-microchip"></i> VocalVibe Pro</div>
        <a class="nav-item" href="dashboard.html"><i class="fas fa-th-large"></i> Overview</a>
        <a class="nav-item active" href="record.html"><i class="fas fa-microphone"></i> Voice Scan</a>
        <a class="nav-item" href="history.html"><i class="fas fa-history"></i> History</a>
        <div class="logout-wrap">
            <a class="nav-item" href="#" onclick="logout()" style="color:#fca5a5;"><i class="fas fa-sign-out-alt"></i> Log Out</a>
        </div>
    </aside>

    <main class="main">
        <div class="header">
            <div>
                <h1>Vocal Stress Scan</h1>
                <p class="muted">Record or upload audio for stress analysis</p>
            </div>
            <div class="user-pill" id="user-pill">Loading session...</div>
        </div>

        <section class="record-card">
            <div id="error-msg" class="msg error"></div>
            <div id="success-msg" class="msg success"></div>

            <div class="pulse-wrapper" id="pulse-wrap">
                <div class="pulse-ring"></div>
                <div class="pulse-ring"></div>
                <div class="pulse-ring"></div>
                <button id="record-btn" class="mic-btn" title="Start/Stop Recording">
                    <i class="fas fa-microphone"></i>
                </button>
            </div>

            <div class="timer" id="timer">00:00</div>
            <p id="status-text" class="status">Click microphone to start recording.</p>

            <div class="actions">
                <button id="play-btn" class="btn" onclick="playRecording()" disabled><i class="fas fa-play"></i> Playback</button>
                <button id="analyze-btn" class="btn primary" onclick="submitAudio()" disabled><i class="fas fa-brain"></i> Analyze Tone</button>
                <button id="reset-btn" class="btn" onclick="resetRecording()" disabled><i class="fas fa-redo"></i> Reset</button>
            </div>

            <label class="upload-box" for="file-input">
                <div><i class="fas fa-cloud-upload-alt"></i> Import Audio File</div>
                <div style="font-size:0.82rem; margin-top:6px;">WAV / MP3 / M4A supported</div>
            </label>
            <input id="file-input" type="file" accept="audio/*" style="display:none;" />
        </section>
    </main>

    <script>
        const API_BASE = window.location.origin;
        let mediaRecorder = null;
        let chunks = [];
        let currentBlob = null;
        let currentMimeType = 'audio/webm';
        let timerId = null;
        let startedAt = 0;
        let playbackAudio = null;

        const recordBtn = document.getElementById('record-btn');
        const pulseWrap = document.getElementById('pulse-wrap');
        const timerEl = document.getElementById('timer');
        const statusText = document.getElementById('status-text');
        const playBtn = document.getElementById('play-btn');
        const analyzeBtn = document.getElementById('analyze-btn');
        const resetBtn = document.getElementById('reset-btn');

        function getActiveEmail() {
            const patientEmail = sessionStorage.getItem('activeUser');
            if (patientEmail) return patientEmail;

            const adminToken = localStorage.getItem('adminToken');
            const adminEmail = localStorage.getItem('adminEmail');
            if (adminToken && adminEmail) return adminEmail;

            return null;
        }

        function showMsg(text, type) {
            const errorEl = document.getElementById('error-msg');
            const successEl = document.getElementById('success-msg');
            errorEl.style.display = 'none';
            successEl.style.display = 'none';

            const el = type === 'error' ? errorEl : successEl;
            el.textContent = text;
            el.style.display = 'block';
        }

        function clearMsg() {
            document.getElementById('error-msg').style.display = 'none';
            document.getElementById('success-msg').style.display = 'none';
        }

        function setActionState(hasAudio) {
            playBtn.disabled = !hasAudio;
            analyzeBtn.disabled = !hasAudio;
            resetBtn.disabled = !hasAudio;
        }

        function setStatus(text, colorVar) {
            statusText.textContent = text;
            statusText.style.color = colorVar ? `var(${colorVar})` : 'var(--muted)';
        }

        function updateTimer() {
            const sec = Math.floor((Date.now() - startedAt) / 1000);
            const mm = String(Math.floor(sec / 60)).padStart(2, '0');
            const ss = String(sec % 60).padStart(2, '0');
            timerEl.textContent = `${mm}:${ss}`;
        }

        function resetTimer() {
            if (timerId) clearInterval(timerId);
            timerId = null;
            timerEl.textContent = '00:00';
        }

        function stopRecorder() {
            if (mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.stop();
        }

        function cleanupStream() {
            if (mediaRecorder && mediaRecorder.stream) {
                mediaRecorder.stream.getTracks().forEach((t) => t.stop());
            }
        }

        async function startRecording() {
            clearMsg();

            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showMsg('Audio recording is not supported in this browser.', 'error');
                return;
            }

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

                if (!window.MediaRecorder) {
                    stream.getTracks().forEach((t) => t.stop());
                    showMsg('MediaRecorder is not available in this browser.', 'error');
                    return;
                }

                mediaRecorder = new MediaRecorder(stream);
                currentMimeType = mediaRecorder.mimeType || 'audio/webm';
                chunks = [];

                mediaRecorder.ondataavailable = (e) => {
                    if (e.data && e.data.size > 0) chunks.push(e.data);
                };

                mediaRecorder.onstart = () => {
                    startedAt = Date.now();
                    timerId = setInterval(updateTimer, 1000);
                    pulseWrap.classList.add('recording');
                    recordBtn.classList.add('recording');
                    recordBtn.innerHTML = '<i class="fas fa-stop"></i>';
                    setStatus('Recording in progress...', '--danger');
                    setActionState(false);
                };

                mediaRecorder.onstop = () => {
                    resetTimer();
                    pulseWrap.classList.remove('recording');
                    recordBtn.classList.remove('recording');
                    recordBtn.innerHTML = '<i class="fas fa-microphone"></i>';

                    cleanupStream();

                    currentBlob = chunks.length ? new Blob(chunks, { type: currentMimeType }) : null;
                    if (currentBlob) {
                        setStatus('Recording complete. Ready to analyze.', '--success');
                        setActionState(true);
                    } else {
                        setStatus('No audio captured. Try again.', '--muted');
                        setActionState(false);
                    }
                };

                mediaRecorder.start();
            } catch (err) {
                showMsg('Microphone access denied or unavailable.', 'error');
            }
        }

        recordBtn.addEventListener('click', async () => {
            if (!mediaRecorder || mediaRecorder.state === 'inactive') {
                await startRecording();
            } else {
                stopRecorder();
            }
        });

        function playRecording() {
            if (!currentBlob) {
                showMsg('No audio available to play.', 'error');
                return;
            }

            if (playbackAudio) {
                playbackAudio.pause();
                playbackAudio = null;
            }

            const url = URL.createObjectURL(currentBlob);
            playbackAudio = new Audio(url);
            playbackAudio.onended = () => URL.revokeObjectURL(url);
            playbackAudio.play();
            setStatus('Playing captured audio...', '--muted');
        }

        function getUploadFilename() {
            if (currentBlob && currentBlob.name) return currentBlob.name;
            if (currentMimeType.includes('wav')) return 'recording.wav';
            if (currentMimeType.includes('mpeg')) return 'recording.mp3';
            if (currentMimeType.includes('mp4')) return 'recording.m4a';
            return 'recording.webm';
        }

        async function submitAudio() {
            clearMsg();
            if (!currentBlob) {
                showMsg('Please record or upload audio first.', 'error');
                return;
            }

            const email = getActiveEmail();
            if (!email) {
                window.location.href = 'login.html';
                return;
            }

            analyzeBtn.disabled = true;
            analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

            const form = new FormData();
            form.append('audio', currentBlob, getUploadFilename());
            form.append('user_email', email);

            try {
                const res = await fetch(`${API_BASE}/api/upload`, { method: 'POST', body: form });
                const text = await res.text();
                let data = {};
                try { data = text ? JSON.parse(text) : {}; } catch { data = {}; }

                if (!res.ok || data.status !== 'success') {
                    throw new Error(data.message || 'Upload failed.');
                }

                showMsg('Analysis completed. Redirecting to history...', 'success');
                setTimeout(() => { window.location.href = 'history.html'; }, 1000);
            } catch (err) {
                showMsg(err.message || 'Unable to analyze audio.', 'error');
            } finally {
                analyzeBtn.disabled = false;
                analyzeBtn.innerHTML = '<i class="fas fa-brain"></i> Analyze Tone';
            }
        }

        function resetRecording() {
            stopRecorder();
            cleanupStream();
            currentBlob = null;
            chunks = [];
            currentMimeType = 'audio/webm';
            if (playbackAudio) {
                playbackAudio.pause();
                playbackAudio = null;
            }
            resetTimer();
            pulseWrap.classList.remove('recording');
            recordBtn.classList.remove('recording');
            recordBtn.innerHTML = '<i class="fas fa-microphone"></i>';
            setActionState(false);
            setStatus('Click microphone to start recording.', '--muted');
            clearMsg();
            document.getElementById('file-input').value = '';
        }

        document.getElementById('file-input').addEventListener('change', (e) => {
            clearMsg();
            const file = e.target.files && e.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('audio/')) {
                showMsg('Please upload a valid audio file.', 'error');
                return;
            }

            currentBlob = file;
            currentMimeType = file.type || 'audio/mpeg';
            setActionState(true);
            resetTimer();
            setStatus(`File loaded: ${file.name}`, '--success');
        });

        function logout() {
            sessionStorage.removeItem('activeUser');
            localStorage.removeItem('adminToken');
            localStorage.removeItem('adminEmail');
            window.location.href = 'index.html';
        }

        window.onload = () => {
            const email = getActiveEmail();
            if (!email) {
                window.location.href = 'login.html';
                return;
            }
            document.getElementById('user-pill').innerText = email;
            setActionState(false);
        };
    </script>
</body>
</html>

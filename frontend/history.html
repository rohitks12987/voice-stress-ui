<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis History | VocalVibe Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0ea5e9;
            --bg: #020617;
            --surface: #0f172a;
            --surface-2: #111c31;
            --border: rgba(255, 255, 255, 0.1);
            --text: #f8fafc;
            --muted: #94a3b8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background: var(--bg); color: var(--text); min-height: 100vh; display: flex; }

        .sidebar {
            width: 240px;
            background: var(--surface);
            border-right: 1px solid var(--border);
            padding: 24px 14px;
            position: fixed;
            inset: 0 auto 0 0;
        }

        .brand { display: flex; align-items: center; gap: 10px; font-weight: 800; margin-bottom: 24px; }
        .brand i {
            width: 34px; height: 34px; display: grid; place-items: center;
            border-radius: 8px; background: linear-gradient(135deg, #0ea5e9, #6366f1);
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 14px;
            color: var(--muted);
            text-decoration: none;
            border-radius: 10px;
            margin-bottom: 8px;
            border: 1px solid transparent;
        }
        .nav-item:hover, .nav-item.active { color: var(--primary); border-color: var(--border); background: var(--surface-2); }

        .logout-wrap { margin-top: 24px; }

        .main {
            margin-left: 240px;
            width: calc(100% - 240px);
            padding: 28px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .muted { color: var(--muted); }

        .user-pill {
            border: 1px solid var(--border);
            background: var(--surface);
            padding: 8px 12px;
            border-radius: 999px;
            font-size: 0.88rem;
        }

        .stats { display: grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap: 12px; margin-bottom: 14px; }

        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 16px;
        }

        .label { font-size: 0.78rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; }
        .value { font-size: 1.7rem; font-weight: 800; margin-top: 6px; }

        .toolbar {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }

        .btn-group { display: flex; gap: 8px; }

        .btn {
            border: 1px solid var(--border);
            background: #18253d;
            color: var(--text);
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.82rem;
            font-weight: 600;
        }
        .btn:hover { border-color: #335277; }
        .btn.active { background: var(--primary); border-color: var(--primary); }

        .search {
            border: 1px solid var(--border);
            border-radius: 8px;
            background: #0e1a2f;
            color: var(--text);
            padding: 8px 10px;
            min-width: 250px;
            outline: none;
        }

        .table-wrap {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 14px;
            overflow: auto;
        }

        table { width: 100%; border-collapse: collapse; min-width: 760px; }
        th, td { padding: 12px; border-bottom: 1px solid var(--border); text-align: left; font-size: 0.88rem; }
        th { color: var(--muted); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.04em; }

        .pill { font-size: 0.75rem; font-weight: 700; padding: 4px 8px; border-radius: 999px; }
        .pill.low { color: #052e1f; background: #6ee7b7; }
        .pill.moderate { color: #3f2a00; background: #fcd34d; }
        .pill.high { color: #450a0a; background: #fca5a5; }

        .empty { text-align: center; color: var(--muted); padding: 24px; }

        @media (max-width: 980px) {
            .sidebar { position: static; width: 100%; height: auto; }
            body { display: block; }
            .main { margin-left: 0; width: 100%; }
            .stats { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>
    <aside class="sidebar">
        <div class="brand"><i class="fas fa-microchip"></i> VocalVibe Pro</div>
        <a class="nav-item" href="dashboard.html"><i class="fas fa-th-large"></i> Overview</a>
        <a class="nav-item" href="record.html"><i class="fas fa-microphone"></i> Voice Scan</a>
        <a class="nav-item active" href="history.html"><i class="fas fa-history"></i> History</a>
        <div class="logout-wrap">
            <a class="nav-item" href="#" onclick="logout()" style="color:#fca5a5;"><i class="fas fa-sign-out-alt"></i> Log Out</a>
        </div>
    </aside>

    <main class="main">
        <div class="header">
            <div>
                <h1>Clinical Analysis History</h1>
                <p class="muted">Records for <span id="user-display">Loading...</span></p>
            </div>
            <div class="user-pill" id="session-pill">Session</div>
        </div>

        <div class="stats">
            <div class="card"><div class="label">Total Analyses</div><div class="value" id="stat-total">0</div></div>
            <div class="card"><div class="label">High Stress</div><div class="value" id="stat-high" style="color:var(--danger)">0</div></div>
            <div class="card"><div class="label">Average Score</div><div class="value" id="stat-avg">0.0</div></div>
            <div class="card"><div class="label">Top Emotion</div><div class="value" id="stat-emotion" style="font-size:1.3rem">--</div></div>
        </div>

        <div class="toolbar">
            <div class="btn-group">
                <button class="btn active" data-filter="all" onclick="setFilter('all', this)">All</button>
                <button class="btn" data-filter="7" onclick="setFilter('7', this)">7 Days</button>
                <button class="btn" data-filter="30" onclick="setFilter('30', this)">30 Days</button>
            </div>
            <div class="btn-group">
                <input id="search-input" class="search" placeholder="Search emotion or stress..." oninput="applyFilters()" />
                <button class="btn" onclick="refresh()"><i class="fas fa-sync-alt"></i> Refresh</button>
            </div>
        </div>

        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Stress</th>
                        <th>Emotion</th>
                        <th>Score</th>
                        <th>Audio</th>
                    </tr>
                </thead>
                <tbody id="history-body"></tbody>
            </table>
            <div id="empty" class="empty" style="display:none;">No records found.</div>
        </div>
    </main>

    <script>
        const API_BASE = window.location.origin;
        let allRows = [];
        let currentFilter = 'all';

        function getActiveEmail() {
            const patientEmail = sessionStorage.getItem('activeUser');
            if (patientEmail) return patientEmail;

            const adminToken = localStorage.getItem('adminToken');
            const adminEmail = localStorage.getItem('adminEmail');
            if (adminToken && adminEmail) return adminEmail;

            return null;
        }

        function logout() {
            sessionStorage.removeItem('activeUser');
            localStorage.removeItem('adminToken');
            localStorage.removeItem('adminEmail');
            window.location.href = 'index.html';
        }

        function safeDate(row) {
            if (row.created_at) {
                const d = new Date(row.created_at);
                if (!Number.isNaN(d.getTime())) return d;
            }
            if (row.date) {
                const d = new Date(row.date);
                if (!Number.isNaN(d.getTime())) return d;
            }
            return null;
        }

        function setFilter(days, btn) {
            currentFilter = days;
            document.querySelectorAll('[data-filter]').forEach((b) => b.classList.remove('active'));
            btn.classList.add('active');
            applyFilters();
        }

        function stressPill(level) {
            const value = String(level || '').toLowerCase();
            if (value.includes('high')) return '<span class="pill high">High</span>';
            if (value.includes('mod')) return '<span class="pill moderate">Moderate</span>';
            return '<span class="pill low">Low</span>';
        }

        function updateStats(rows) {
            const total = rows.length;
            const highCount = rows.filter((r) => String(r.stress_level || '').toLowerCase().includes('high')).length;
            const avg = total
                ? rows.reduce((sum, r) => sum + (Number(r.score) || 0), 0) / total
                : 0;

            const emotionCount = {};
            rows.forEach((r) => {
                const key = (r.emotion || 'Unknown').trim();
                emotionCount[key] = (emotionCount[key] || 0) + 1;
            });

            let topEmotion = '--';
            let maxCount = 0;
            Object.keys(emotionCount).forEach((k) => {
                if (emotionCount[k] > maxCount) {
                    maxCount = emotionCount[k];
                    topEmotion = k;
                }
            });

            document.getElementById('stat-total').innerText = String(total);
            document.getElementById('stat-high').innerText = String(highCount);
            document.getElementById('stat-avg').innerText = avg.toFixed(1);
            document.getElementById('stat-emotion').innerText = topEmotion;
        }

        function renderTable(rows) {
            const body = document.getElementById('history-body');
            const empty = document.getElementById('empty');

            if (!rows.length) {
                body.innerHTML = '';
                empty.style.display = 'block';
                return;
            }

            empty.style.display = 'none';
            body.innerHTML = rows.map((row) => {
                const score = Number(row.score || 0).toFixed(1);
                const audio = row.audio_file ? `<a class="btn" href="/uploads/${encodeURIComponent(row.audio_file)}" target="_blank">Open</a>` : '--';
                return `
                    <tr>
                        <td>${row.date || '--'}</td>
                        <td>${row.time || '--:--'}</td>
                        <td>${stressPill(row.stress_level || 'Low')}</td>
                        <td>${row.emotion || 'Unknown'}</td>
                        <td>${score}</td>
                        <td>${audio}</td>
                    </tr>
                `;
            }).join('');
        }

        function applyFilters() {
            let filtered = [...allRows];

            if (currentFilter !== 'all') {
                const days = Number(currentFilter);
                const cutoff = new Date();
                cutoff.setDate(cutoff.getDate() - days);
                filtered = filtered.filter((row) => {
                    const d = safeDate(row);
                    return d ? d >= cutoff : false;
                });
            }

            const term = document.getElementById('search-input').value.trim().toLowerCase();
            if (term) {
                filtered = filtered.filter((row) => {
                    const stress = String(row.stress_level || '').toLowerCase();
                    const emotion = String(row.emotion || '').toLowerCase();
                    return stress.includes(term) || emotion.includes(term);
                });
            }

            updateStats(filtered);
            renderTable(filtered);
        }

        async function refresh() {
            const email = getActiveEmail();
            if (!email) {
                window.location.href = 'login.html';
                return;
            }

            document.getElementById('user-display').innerText = email;
            document.getElementById('session-pill').innerText = email;

            try {
                const res = await fetch(`${API_BASE}/api/history?user_email=${encodeURIComponent(email)}`);
                if (!res.ok) throw new Error('Failed to load history.');

                const rows = await res.json();
                allRows = Array.isArray(rows) ? rows : [];
                applyFilters();
            } catch (err) {
                allRows = [];
                renderTable([]);
                updateStats([]);
                document.getElementById('empty').innerText = err.message;
                document.getElementById('empty').style.display = 'block';
            }
        }

        window.onload = refresh;
    </script>
</body>
</html>
